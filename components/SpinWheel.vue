<script setup lang="ts">
import {
	Chart,
	ArcElement,
	PieController,
	type PieControllerChartOptions,
} from "chart.js";
import ChartDataLabels from "chartjs-plugin-datalabels";
import { useTeamsStore } from "~/store/teams";
import type { ChartData } from "chart.js/dist/types";
import { remap } from "@antfu/utils";

Chart.register(ArcElement, PieController);

const teamsStore = useTeamsStore();

const { teams } = storeToRefs(teamsStore);

const teamAngle = computed(() => 360 / teams.value.teams.length);

const data = computed<ChartData>(() => ({
	labels: teams.value.teams.map((team) => team.name),
	datasets: [
		{
			backgroundColor: teams.value.teams.map((team) => team.colorHex),
			data: teams.value.teams.map(() => 1),
		},
	],
}));

const options: PieControllerChartOptions = {
	responsive: true,
	animation: {
		duration: 0,
	},
	plugins: {
		tooltip: false,
		legend: {
			display: false,
		},
		datalabels: {
			color: "#ffffff",
			formatter: (_, context) =>
				context.chart.data.labels[context.dataIndex],
			font: { size: 24 },
		},
	},
	rotation: -(teamAngle.value / 2),
};

const canvas = ref(null);
let chart: Chart<"pie", 1[], string>;

watch(teams.value, () => {
	chart.data = data.value;
	chart.options.rotation = -(teamAngle.value / 2);
	chart.update();
});

onMounted(() => {
	chart = new Chart(canvas.value, {
		type: "pie",
		data: data.value,
		plugins: [ChartDataLabels],
		options,
	});
});

let isRotated = false;
const startSpin = () => {
	if (chart) {
		const rotationTimes = remap(Math.random(), 0, 1, 7, 10);
		const additionalRotationAngle = Math.random() * teamAngle.value;

		isRotated = true;
		chart.options.rotation += rotationTimes * 360 + additionalRotationAngle;
		chart.options.animation = {
			duration: 5000,
			easing: "easeOutSine",
			onComplete: (event) => {
				if (isRotated) {
					chart.options.animation = {
						duration: 0,
						onComplete: () => {},
					};
					chart.update();
				}
			},
		};
		chart.update();
	}
};
</script>

<template>
	<canvas ref="canvas" @click="onClick" />
	<button @click="onClick">Spin</button>
</template>

<style scoped></style>
