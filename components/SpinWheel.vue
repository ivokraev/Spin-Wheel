<script setup lang="ts">
import { Chart, ArcElement, PieController, type ChartOptions } from "chart.js";
import ChartDataLabels from "chartjs-plugin-datalabels";
import { useTeamsStore } from "~/store/teams";
import type { ChartData } from "chart.js/dist/types";
import { remap } from "@antfu/utils";
import type { Team } from "~/schemas/Team";

Chart.register(ArcElement, PieController, ChartDataLabels);

const teamsStore = useTeamsStore();

const { RemoveTeam } = teamsStore;

const { teams } = storeToRefs(teamsStore);

const teamAngle = computed(() => 360 / teams.value.teams.length);

let pervCount: number = teams.value.teams.length;

const data = computed<ChartData<"pie", 1[], string>>(() => ({
	labels: teams.value.teams.map((team) => team.name),
	datasets: [
		{
			backgroundColor: teams.value.teams.map((team) => team.colorHex),
			data: teams.value.teams.map(() => 1),
		},
	],
}));

const options: ChartOptions<"pie"> = {
	animation: {
		duration: 0,
	},
	plugins: {
		tooltip: {
			enabled: false,
		},
		legend: {
			display: false,
		},
		datalabels: {
			color: teams.value.teams.map((team) =>
				calculateFontColor(team.colorHex),
			),
			formatter: (_, context) =>
				context.chart.data.labels
					? context.chart.data.labels[context.dataIndex]
					: "",
			font: { size: 24 },
		},
	},
	responsive: true,
	rotation: -(teamAngle.value / 2),
};

const canvas = ref(null);
let chart: Chart<"pie", 1[], string>;
const dialog = ref(false);
const winnerTeam = ref<Team>();

watch(teams.value, () => {
	if (!chart.options.plugins || !chart.options.plugins.datalabels) return;

	chart.data = data.value;
	chart.options.plugins.datalabels.color = teams.value.teams.map((team) =>
		calculateFontColor(team.colorHex),
	);
	if (pervCount < teams.value.teams.length)
		chart.options.rotation = -(teamAngle.value / 2);
	if (teams.value.teams.length > 10)
		chart.options.plugins.datalabels.rotation = teams.value.teams.map(
			(team, index) => 270 + teamAngle.value * index,
		);
	else chart.options.plugins.datalabels.rotation = 0;
	pervCount = teams.value.teams.length;
	chart.update();
});

onMounted(() => {
	if (!canvas.value) return;
	chart = new Chart<"pie", 1[], string>(canvas.value, {
		type: "pie",
		data: data.value,
		options,
	});
});

let isRotated = false;
const startSpin = () => {
	if (!chart || !chart.options.rotation) return;

	const rotationTimes = remap(Math.random(), 0, 1, 7, 10);
	const additionalRotationAngle = Math.random() * 360;

	isRotated = true;
	chart.options.rotation += rotationTimes * 360 + additionalRotationAngle;
	chart.options.animation = {
		duration: 5000,
		easing: "easeOutSine",
		onComplete: async (event) => {
			clearAnimation();

			if (isRotated && chart.options.rotation)
				await checkWinner(chart.options.rotation);
			isRotated = false;
		},
	};
	chart.update();
};

async function checkWinner(rotation: number) {
	const currentAngle = rotation % 360;
	const winnerIndex =
		teams.value.teams.length -
		Math.floor(currentAngle / teamAngle.value) -
		1;

	const winnerId = teams.value.teams[winnerIndex].id;

	await new Promise<void>((resolve, reject) =>
		setTimeout(() => {
			winnerTeam.value = teams.value.teams[winnerIndex];
			dialog.value = true;

			RemoveTeam(winnerId);
			resolve();
		}, 3000),
	);
}

function clearAnimation() {
	chart.options.animation = {
		duration: 0,
		onComplete: () => {},
	};
	chart.update();
}
</script>

<template>
	<div class="relative w-[1000px]">
		<canvas ref="canvas" />
		<button
			@click="startSpin"
			class="absolute top-1/2 left-1/2 -translate-x-2/4 -translate-y-2/4 bg-white w-32 h-32 rounded-full text text-3xl after:content-[''] after:absolute after:-top-[75px] after:left-1/2 after:-translate-x-1/2 after:w-0 after:h-0 after:border-b-white after:border-x-transparent after:border-t-0 after:border-x-[20px] after:border-b-[80px]"
		>
			Spin
		</button>
		<v-dialog v-model="dialog" width="auto">
			<v-card>
				<v-card-text class="text-h4">
					The winner is {{ winnerTeam!.name }}
				</v-card-text>
				<v-card-actions>
					<v-btn color="error" :block="true" @click="dialog = false"
						>Close</v-btn
					>
				</v-card-actions>
			</v-card>
		</v-dialog>
	</div>
</template>

<style scoped></style>
